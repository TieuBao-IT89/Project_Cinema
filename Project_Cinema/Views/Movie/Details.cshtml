@using System.Text.Json
@model Project_Cinema.ViewModels.MovieDetailsViewModel

@{
    var movie = Model.Movie;
    ViewData["Title"] = $"{movie.Title} - Chi tiết phim";
    var posterUrl = string.IsNullOrWhiteSpace(movie.PosterUrl)
        ? $"https://via.placeholder.com/400x600?text={movie.Title}"
        : movie.PosterUrl;
    var bannerUrl = string.IsNullOrWhiteSpace(movie.PosterUrl)
        ? "https://images.unsplash.com/photo-1489599849927-2ee91cede3ba?w=1920"
        : movie.PosterUrl;
    var isNew = movie.ReleaseDate != null && movie.ReleaseDate.Value >= DateTime.Today.AddDays(-30);
    var isHot = string.Equals(movie.Status, "now_showing", StringComparison.OrdinalIgnoreCase);

    var showtimeDataJson = JsonSerializer.Serialize(Model.Showtimes.Select(s => new
    {
        showtimeId = s.ShowtimeId,
        startsAt = s.StartsAt,
        dateKey = s.StartsAt.ToString("yyyy-MM-dd"),
        time = s.StartsAt.ToString("HH:mm"),
        basePrice = s.BasePrice,
        cinemaId = s.CinemaId,
        cinemaName = s.CinemaName,
        cinemaAddress = s.CinemaAddress,
        roomName = s.RoomName,
        roomType = s.RoomType
    }));
}

@section Styles {
    <link rel="stylesheet" href="~/css/movie-details.css" />
}

<!-- Movie Banner Hero Section -->
<section class="movie-banner">
    <div class="movie-banner-image" style="background-image: url('@bannerUrl');"></div>
    <div class="movie-banner-overlay"></div>
    <div class="movie-banner-content">
        <div class="container">
            <div class="movie-banner-info">
                <div class="movie-banner-badges">
                    @if (isHot)
                    {
                        <span class="badge badge-hot">HOT</span>
                    }
                    @if (isNew)
                    {
                        <span class="badge badge-new">NEW</span>
                    }
                </div>
                <h1 class="movie-banner-title">@movie.Title</h1>
                <div class="movie-banner-meta">
                    <span class="meta-item">
                        <i class="fas fa-globe"></i>
                        <span>@(movie.Language ?? "Chưa cập nhật")</span>
                    </span>
                    <span class="meta-item">
                        <i class="fas fa-clock"></i>
                        <span>@movie.DurationMin phút</span>
                    </span>
                    <span class="meta-item">
                        <i class="fas fa-calendar"></i>
                        <span>@(movie.ReleaseDate?.ToString("dd/MM/yyyy") ?? "Chưa cập nhật")</span>
                    </span>
                    <span class="meta-item">
                        <i class="fas fa-user-friends"></i>
                        <span>@(movie.AgeRating ?? "Chưa cập nhật")</span>
                    </span>
                </div>
                <p class="movie-banner-description">
                    @(string.IsNullOrWhiteSpace(movie.Description) ? "Chưa cập nhật nội dung phim." : movie.Description)
                </p>
                <div class="movie-banner-actions">
                    <a href="#showtimes" class="btn btn-primary btn-large">
                        <i class="fas fa-ticket-alt"></i> Đặt vé ngay
                    </a>
                    <a href="#trailer" class="btn btn-secondary btn-large">
                        <i class="fas fa-play"></i> Xem trailer
                    </a>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Movie Overview Section -->
<section class="movie-overview">
    <div class="container">
        <div class="overview-grid">
            <div class="overview-poster">
                <img src="@posterUrl" alt="@movie.Title">
                <div class="poster-overlay">
                    <a href="@posterUrl" target="_blank" rel="noopener noreferrer" class="btn btn-primary">
                        <i class="fas fa-images"></i> Xem poster
                    </a>
                </div>
            </div>
            <div class="overview-info">
                <h2 class="overview-title">Thông tin phim</h2>
                <div class="info-grid">
                    <div class="info-item">
                        <span class="info-label">
                            <i class="fas fa-film"></i> Tên phim:
                        </span>
                        <span class="info-value">@movie.Title</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">
                            <i class="fas fa-clock"></i> Thời lượng:
                        </span>
                        <span class="info-value">@movie.DurationMin phút</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">
                            <i class="fas fa-globe"></i> Ngôn ngữ:
                        </span>
                        <span class="info-value">@(movie.Language ?? "Chưa cập nhật")</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">
                            <i class="fas fa-calendar-alt"></i> Ngày khởi chiếu:
                        </span>
                        <span class="info-value">@(movie.ReleaseDate?.ToString("dd/MM/yyyy") ?? "Chưa cập nhật")</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">
                            <i class="fas fa-user-friends"></i> Độ tuổi:
                        </span>
                        <span class="info-value">@(movie.AgeRating ?? "Chưa cập nhật")</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">
                            <i class="fas fa-info-circle"></i> Trạng thái:
                        </span>
                        <span class="info-value">@movie.Status</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Movie Description Section -->
<section class="movie-description">
    <div class="container">
        <h2 class="section-title">Nội dung phim</h2>
        <div class="description-content">
            <p>
                @(string.IsNullOrWhiteSpace(movie.Description)
                    ? "Chưa cập nhật nội dung phim."
                    : movie.Description)
            </p>
        </div>
    </div>
</section>

<!-- Trailer Section -->
<section id="trailer" class="trailer-section" data-trailer-url="@movie.TrailerUrl">
    <div class="container">
        <div class="trailer-header">
            <h2 class="section-title">Trailer phim</h2>
            <p class="trailer-subtitle">Xem trước đoạn giới thiệu của bộ phim</p>
        </div>

        @if (!string.IsNullOrWhiteSpace(movie.TrailerUrl))
        {
            <div class="trailer-wrapper">
                <div class="trailer-preview" id="trailerPreview">
                    <div class="trailer-thumbnail" style="background-image: url('@bannerUrl');">
                        <div class="trailer-overlay"></div>
                        <div class="play-button-container">
                            <button class="play-button" onclick="playTrailer()">
                                <i class="fas fa-play"></i>
                            </button>
                            <div class="play-button-ripple"></div>
                        </div>
                        <div class="trailer-info-overlay">
                            <h3 class="trailer-title">Official Trailer</h3>
                        </div>
                    </div>
                </div>
                <div class="trailer-video" id="trailerVideo" style="display: none;">
                    <button class="close-trailer" onclick="closeTrailer()">
                        <i class="fas fa-times"></i>
                    </button>
                    <iframe
                        id="trailerIframe"
                        src=""
                        title="@movie.Title Trailer"
                        frameborder="0"
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                        allowfullscreen>
                    </iframe>
                </div>
            </div>
        }
        else
        {
            <div class="trailer-empty">
                Trailer đang được cập nhật.
            </div>
        }
    </div>
</section>

<!-- Showtimes Section -->
<section id="showtimes" class="showtimes-section">
    <div class="container">
        <h2 class="section-title">Đặt vé nhanh</h2>

        <script>
            window.__movieShowtimes = @Html.Raw(showtimeDataJson);
            window.__movieId = @movie.MovieId;
        </script>

        <div class="quick-booking-card">
            <div class="quick-booking-head">
                <div class="quick-booking-title">
                    <i class="fas fa-ticket-alt"></i> Chọn rạp, ngày và suất chiếu
                </div>
                <a class="quick-booking-link" asp-controller="Showtime" asp-action="Index" asp-route-movieId="@movie.MovieId">
                    Xem lịch chiếu đầy đủ <i class="fas fa-arrow-right"></i>
                </a>
            </div>

            <div class="quick-booking-grid">
                <div class="qb-field">
                    <label class="qb-label"><i class="fas fa-building"></i> Rạp</label>
                    <select id="md-cinema" class="qb-control"></select>
                </div>
                <div class="qb-field">
                    <label class="qb-label"><i class="fas fa-calendar"></i> Ngày</label>
                    <select id="md-date" class="qb-control"></select>
                </div>
                <div class="qb-field">
                    <label class="qb-label"><i class="fas fa-clock"></i> Suất</label>
                    <select id="md-showtime" class="qb-control"></select>
                </div>
                <div class="qb-field qb-cta">
                    <button class="btn btn-primary btn-large" type="button" id="md-bookNow" disabled>
                        <i class="fas fa-chair"></i> Đặt vé ngay
                    </button>
                </div>
            </div>

            <div class="qb-hint" id="md-hint" style="display:none;"></div>
        </div>
    </div>
</section>

<!-- Related Movies Section -->
<section class="related-movies">
    <div class="container">
        <h2 class="section-title">Phim liên quan</h2>
        <div class="movies-grid">
            <div class="movie-card">
                <div class="movie-info">
                    <h3 class="movie-name">Xem thêm phim khác</h3>
                    <div class="movie-details">
                        <span class="genre">Danh sách phim hiện có</span>
                    </div>
                    <a class="btn btn-sm btn-primary mt-3" asp-controller="Movie" asp-action="Index">
                        Xem danh sách phim
                    </a>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Reviews Section -->
<section class="reviews-section">
    <div class="container">
        <h2 class="section-title">Đánh giá & Bình luận</h2>
        <div class="reviews-grid">
            <div class="review-card">
                <div class="review-header">
                    <div class="reviewer-info">
                        <div class="reviewer-avatar">
                            <i class="fas fa-user"></i>
                        </div>
                        <div class="reviewer-details">
                            <h4 class="reviewer-name">Nguyễn Văn A</h4>
                            <div class="review-rating">
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star"></i>
                                <i class="fas fa-star"></i>
                                <span class="rating-text">5.0</span>
                            </div>
                        </div>
                    </div>
                    <span class="review-date">2 ngày trước</span>
                </div>
                <p class="review-content">
                    Phim rất hấp dẫn, kỹ xảo đẹp và nội dung cảm xúc. Rất đáng xem!
                </p>
            </div>
        </div>
    </div>
</section>

@section Scripts {
    <script src="~/js/movie-details.js"></script>
    <script src="~/js/movie-booking.js"></script>
}
