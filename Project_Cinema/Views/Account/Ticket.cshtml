@using System.Text.Json
@model Project_Cinema.ViewModels.TicketDetailsViewModel

@{
    ViewData["Title"] = "Chi tiết vé";

    var statusTitle = Model.IsPaid ? "Vé hợp lệ" : "Vé không còn hiệu lực";
    var statusMessage = Model.IsPaid
        ? "Vé của bạn đã được xác nhận. Vui lòng xuất trình mã/QR khi đến rạp."
        : (Model.IsCancelled ? "Vé đã bị hủy. Nếu bạn muốn xem phim, hãy đặt lại vé." : "Vé đã hết hạn. Vui lòng đặt lại vé để tiếp tục.");

    var jsPayload = JsonSerializer.Serialize(new
    {
        bookingCode = Model.BookingCode,
        customerEmail = Model.CustomerEmail,
        customerName = Model.CustomerName,
        movie = Model.MovieTitle,
        cinema = Model.CinemaName,
        cinemaAddress = Model.CinemaAddress,
        room = Model.RoomName,
        date = Model.StartsAt.ToString("dd/MM/yyyy"),
        time = Model.StartsAt.ToString("HH:mm"),
        seats = Model.SeatCodes,
        totalPrice = Model.TotalAmount.ToString("N0") + "đ",
        providerTxn = Model.ProviderTxn,
        method = Model.PaymentMethod
    });
}

@section Styles {
    <link rel="stylesheet" href="~/css/booking-success.css" />
}

<script>
    window.__bookingSuccessData = @Html.Raw(jsPayload);
</script>

<section class="success-section">
    <div class="container">
        <div class="success-content">
            <div class="success-icon-wrapper">
                <div class="success-icon" style="@(Model.IsPaid ? "" : "background: linear-gradient(135deg, #0f172a 0%, #334155 100%);")">
                    <i class="fas @(Model.IsPaid ? "fa-check" : "fa-exclamation")"></i>
                </div>
                <div class="success-ripple"></div>
                <div class="success-ripple"></div>
                <div class="success-ripple"></div>
            </div>

            <h1 class="success-title">@statusTitle</h1>
            <p class="success-message">@statusMessage</p>

            <div class="booking-code-card">
                <div class="booking-code-label">
                    <i class="fas fa-ticket-alt"></i> Mã đặt vé
                </div>
                <div class="booking-code-value" id="bookingCode">@Model.BookingCode</div>
                <button class="btn-copy-code" onclick="copyBookingCode()" title="Sao chép mã">
                    <i class="fas fa-copy"></i>
                </button>
            </div>

            <div class="notification-banner" style="@(string.IsNullOrWhiteSpace(Model.CustomerEmail) ? "display:none;" : "")">
                <div class="notification-icon">
                    <i class="fas fa-envelope"></i>
                </div>
                <div class="notification-content">
                    <strong>Email</strong>
                    <span id="customerEmail">@Model.CustomerEmail</span>
                </div>
            </div>
        </div>
    </div>
</section>

<section class="ticket-details-section">
    <div class="container">
        <div class="ticket-details-layout">
            <div class="ticket-info-column">
                <h2 class="section-title-success">
                    <i class="fas fa-info-circle"></i> Chi tiết vé
                </h2>

                <div class="ticket-card">
                    <div class="ticket-header">
                        <div class="ticket-logo">
                            <i class="fas fa-film"></i>
                            <span>CinemaHub</span>
                        </div>
                        <div class="ticket-type">VÉ XEM PHIM</div>
                    </div>

                    <div class="ticket-body">
                        <div class="ticket-info-item">
                            <div class="ticket-info-label">
                                <i class="fas fa-film"></i> Phim
                            </div>
                            <div class="ticket-info-value" id="ticketMovie">@Model.MovieTitle</div>
                        </div>

                        <div class="ticket-info-item">
                            <div class="ticket-info-label">
                                <i class="fas fa-building"></i> Rạp chiếu
                            </div>
                            <div class="ticket-info-value" id="ticketCinema">@Model.CinemaName</div>
                        </div>

                        <div class="ticket-info-item">
                            <div class="ticket-info-label">
                                <i class="fas fa-door-open"></i> Phòng chiếu
                            </div>
                            <div class="ticket-info-value" id="ticketRoom">@Model.RoomName</div>
                        </div>

                        <div class="ticket-info-row">
                            <div class="ticket-info-item">
                                <div class="ticket-info-label">
                                    <i class="fas fa-calendar"></i> Ngày chiếu
                                </div>
                                <div class="ticket-info-value" id="ticketDate">@Model.StartsAt.ToString("dd/MM/yyyy")</div>
                            </div>
                            <div class="ticket-info-item">
                                <div class="ticket-info-label">
                                    <i class="fas fa-clock"></i> Suất chiếu
                                </div>
                                <div class="ticket-info-value" id="ticketTime">@Model.StartsAt.ToString("HH:mm")</div>
                            </div>
                        </div>

                        <div class="ticket-info-item">
                            <div class="ticket-info-label">
                                <i class="fas fa-chair"></i> Ghế
                            </div>
                            <div class="ticket-seats-list" id="ticketSeats">
                                @foreach (var seat in Model.SeatCodes)
                                {
                                    <span class="ticket-seat-badge">@seat</span>
                                }
                            </div>
                        </div>

                        <div class="ticket-info-item">
                            <div class="ticket-info-label">
                                <i class="fas fa-user"></i> Khách hàng
                            </div>
                            <div class="ticket-info-value" id="ticketCustomer">@Model.CustomerName</div>
                        </div>

                        <div class="ticket-divider"></div>

                        <div class="ticket-price-row">
                            <div class="ticket-price-label">Tổng tiền</div>
                            <div class="ticket-price-value" id="ticketPrice">@Model.TotalAmount.ToString("N0")đ</div>
                        </div>
                    </div>

                    <div class="ticket-footer">
                        <div class="ticket-qr-code">
                            <div class="qr-placeholder">
                                <i class="fas fa-qrcode"></i>
                                <span>QR Code</span>
                            </div>
                        </div>
                        <div class="ticket-barcode">
                            <div class="barcode-placeholder" id="barcode">
                                || ||| || || || ||| ||
                            </div>
                        </div>
                    </div>
                </div>

                <div class="important-notes">
                    <h3 class="notes-title">
                        <i class="fas fa-exclamation-triangle"></i> Lưu ý
                    </h3>
                    <ul class="notes-list">
                        <li><i class="fas fa-check-circle"></i> Vui lòng đến rạp <strong>trước 15 phút</strong> so với giờ chiếu.</li>
                        <li><i class="fas fa-check-circle"></i> Mang theo <strong>mã đặt vé</strong> hoặc <strong>QR</strong> khi đến rạp.</li>
                        @if (!Model.IsPaid)
                        {
                            <li><i class="fas fa-check-circle"></i> Vé hiện tại <strong>không còn hiệu lực</strong>. Bạn có thể đặt lại vé để tiếp tục.</li>
                        }
                    </ul>
                </div>
            </div>

            <div class="action-panel-column">
                <div class="action-card">
                    <h3 class="action-card-title">
                        <i class="fas fa-bolt"></i> Thao tác nhanh
                    </h3>
                    <div class="action-buttons">
                        @if (Model.IsPaid)
                        {
                            <button class="btn-action-primary" onclick="downloadTicket()">
                                <i class="fas fa-download"></i>
                                <span>Tải vé PDF</span>
                            </button>
                            <button class="btn-action-secondary" onclick="shareTicket()">
                                <i class="fas fa-share-alt"></i>
                                <span>Chia sẻ</span>
                            </button>
                        }
                        else
                        {
                            <a class="btn-action-primary" asp-controller="Showtime" asp-action="Index">
                                <i class="fas fa-ticket-alt"></i>
                                <span>Đặt lại vé</span>
                            </a>
                            <a class="btn-action-secondary" asp-controller="Account" asp-action="Profile" asp-route-tab="booking-history" asp-route-status="all" asp-fragment="booking-history">
                                <i class="fas fa-arrow-left"></i>
                                <span>Về danh sách vé</span>
                            </a>
                        }
                    </div>
                </div>

                <div class="cinema-info-card">
                    <h3 class="cinema-info-title">
                        <i class="fas fa-map-marker-alt"></i> Thông tin rạp
                    </h3>
                    <div class="cinema-info-content">
                        <div class="cinema-info-item">
                            <i class="fas fa-building"></i>
                            <div>
                                <strong id="cinemaName">@Model.CinemaName</strong>
                                <span id="cinemaAddress">@Model.CinemaAddress</span>
                            </div>
                        </div>
                        <div class="cinema-info-item">
                            <i class="fas fa-phone"></i>
                            <div>
                                <strong>Hotline</strong>
                                <span>1900 1234</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="support-card">
                    <div class="support-icon">
                        <i class="fas fa-headset"></i>
                    </div>
                    <h3 class="support-title">Cần hỗ trợ?</h3>
                    <p class="support-text">Nếu bạn có bất kỳ thắc mắc nào, chúng tôi luôn sẵn sàng hỗ trợ bạn.</p>
                    <div class="support-contacts">
                        <a href="tel:19001234" class="support-contact">
                            <i class="fas fa-phone"></i> 1900 1234
                        </a>
                        <a href="mailto:support@cinemahub.vn" class="support-contact">
                            <i class="fas fa-envelope"></i> support@cinemahub.vn
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<section class="success-actions-section">
    <div class="container">
        <div class="success-actions">
            <a asp-controller="Account" asp-action="Profile" asp-route-tab="booking-history" asp-route-status="all" asp-fragment="booking-history" class="btn btn-secondary btn-large">
                <i class="fas fa-arrow-left"></i> Về vé của tôi
            </a>
            <a asp-controller="Showtime" asp-action="Index" class="btn btn-outline btn-large">
                <i class="fas fa-film"></i> Xem lịch chiếu
            </a>
        </div>
    </div>
</section>

@section Scripts {
    <script src="~/js/booking-success.js"></script>
}

